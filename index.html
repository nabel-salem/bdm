<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تطبيق قطرة أمل</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
   .btn-update-date {
  background-color: #2e7d32; /* أخضر غامق */
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
}

.btn-update-date:hover {
  background-color: #1b5e20; /* أخضر غامق جدًا عند المرور */
    }
    * { box-sizing: border-box; }
    body { font-family: 'Arial', sans-serif; background: #f0f0f0; margin: 0; padding: 0; }
    header { background-color: #b30000; color: white; text-align: center; padding: 15px; font-size: 20px; }
    nav { display: flex; flex-wrap: wrap; justify-content: space-around; background-color: #ffcccc; padding: 10px; }
    nav button { background-color: #b30000; color: white; border: none; border-radius: 8px; padding: 10px 20px; margin: 5px; cursor: pointer; }
    .section { display: none; padding: 20px; }
    .active { display: block; }
    input, select, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .field-label { color: #b30000; font-size: 14px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    td, th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 10px; text-align: center; }
    thead { background-color: #b30000; color: white; }
    tbody tr { border: 2px solid #b30000; margin-bottom: 10px; }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr { margin-bottom: 15px; border: 2px solid #b30000; padding: 10px; border-radius: 10px; background-color: #fff; }
      td { text-align: right; padding-right: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
      td::before { content: attr(data-label); position: absolute; right: 10px; top: 10px; font-weight: bold; color: #b30000; }
      td:last-child { border-bottom: none; }
    }
    .popup-message, .update-date-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid red; border-radius: 10px; z-index: 1000; text-align: center; }
    .popup-message.active, .update-date-popup.active { display: block; }
  </style>
  <!-- jsPDF and AutoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<header>تطبيق قطرة أمل ... قطرة أمل تنقذ حياة</header>
<p style="font-size: 17px; color: #333; line-height: 1.3; margin: 5px 0; font-weight: 600; text-align: center;">
  تم تصميم هذا الموقع لتسهيل عملية البحث عن المتبرعين بالدم، وسهولة التواصل مع المتبرعين.
</p>

</div>
<nav>
  <button id="btn-show-register">تسجيل متبرع جديد</button>
  <button id="btn-show-password-popup">تعديل البيانات</button>
  <button id="btn-show-search">بحث عن متبرع</button>
</nav>

<div id="register" class="section active">
<h3 style="margin-bottom: 4px;">تسجيل متبرع جديد</h3>
<p style="font-size: 15px; color: #b71c1c; line-height: 1.2; margin-top: 0; font-weight: 500;">
  الرجاء تعبئة البيانات الصحيحة وكتابة الاسم الرباعي (اذا رغبت بتعديل بياناتك تواصل مع نبيل اليافعي على الواتساب 00966511479262).
  <input type="text" id="donorName" placeholder="الاسم الرباعي">
  <input type="tel" id="donorPhone" placeholder="رقم الهاتف" inputmode="numeric" style="text-align: right;">
  <input type="tel" id="donorWhatsapp" placeholder="رقم الواتساب (اكتب الرقم بهذه الصيغة: 967xxxxxxxx" inputmode="numeric" style="text-align: right;" dir="rtl">
  <input type="text" id="donorCity" placeholder="المحافظة">
  <input type="text" id="donorArea" placeholder="المديرية">
  <input type="text" id="donorLocation" placeholder="مكان السكن">
  <label class="field-label">تحديد تاريخ آخر تبرع لك (وإذا لم تتبرع بعد فاتركه فارغاً) ويمكنك تعديله من جدول البيانات في حال قمت بالتبرع.</label>
  <input type="date" id="donorLastDate">
  <select id="donorBlood">
    <option disabled selected value="">اختر فصيلة الدم</option>
    <option>+A</option><option>-A</option>
    <option>+B</option><option>-B</option>
    <option>+AB</option><option>-AB</option>
    <option>+O</option><option>-O</option>
  </select>
  <button id="btn-add-donor">تسجيل</button>
</div>

<div id="edit" class="section">
  <h3>تعديل بيانات متبرع</h3>
  <input type="text" id="editSearchInput" placeholder="ابحث باسم المتبرع أو رقمه للتعديل">
  <button id="btn-search-donor-edit">بحث</button>
  <div id="editSection" style="display:none;">
    <p>جاري تعديل بيانات المتبرع صاحب المعرف: <span id="editingDonorId"></span></p>
    <input type="text" id="editNewName" placeholder="الاسم الكامل">
    <input type="text" id="editPhone" placeholder="رقم الهاتف">
    <input type="text" id="editWhatsapp" placeholder="رقم الواتساب">
    <input type="text" id="editCity" placeholder="المحافظة">
    <input type="text" id="editArea" placeholder="المديرية">
    <input type="text" id="editLocation" placeholder="مكان السكن">
    <input type="date" id="editLastDate">
    <select id="editBlood">
      <option>+A</option><option>-A</option>
      <option>+B</option><option>-B</option>
      <option>+AB</option><option>-AB</option>
      <option>+O</option><option>-O</option>
    </select>
    <button id="btn-save-edit">حفظ التعديل</button>
    <button id="btn-delete-donor">حذف المتبرع</button>
    <button id="btn-cancel-edit">إلغاء</button>
  </div>
</div>

<div id="search" class="section"><h3 style="margin-bottom: 4px;">البحث عن متبرعين</h3>
<p style="font-size: 15px; color: #b71c1c; line-height: 1.2; margin-top: 0; font-weight: 500;">
  للباحثين عن نوع فصيلة دم محددة يمكنك البحث بنوع الفصيلة او ابحث بالمنطقة التي انت فيها لتسهيل العثور على طلبك.
  <select id="searchBlood">
    <option value="">ابحث بنوع الفصيلة</option>
    <option>+A</option><option>-A</option>
    <option>+B</option><option>-B</option>
    <option>+AB</option><option>-AB</option>
    <option>+O</option><option>-O</option>
  </select>
  <input type="text" id="searchQuery" placeholder="بحث بالاسم أو الهاتف أو المحافظة أو المديرية أو السكن">
  <div id="donorCount" style="margin:15px 0;font-size:18px;font-weight:bold;color:#333;text-align:center;"></div>
  <!-- <button id="downloadPdfBtn">تحميل PDF</button> -->
  <table>
    <thead>
      <tr>
        <th>الاسم</th><th>الهاتف</th><th>الفصيلة</th><th>المحافظة</th><th>المديرية</th><th>السكن</th><th>الواتساب</th><th>آخر تبرع</th><th>تعديل تاريخ التبرع</th>
      </tr>
    </thead>
    <tbody id="donorsTable"></tbody>
  </table>
</div>

<div id="successPopup" class="popup-message"></div>
<div id="passwordPopup" class="popup-message">
  <p>للدخول إلى قسم التعديل، يرجى إدخال كلمة المرور.</p>
  <input type="password" id="passwordInput" placeholder="كلمة المرور">
  <button id="btn-check-password">دخول</button>
  <button id="btn-close-password-popup">إغلاق</button>
  <p style="font-size:12px;color:gray;">للتعديل أو الحذف، تواصل على الواتس: 00966511479262 نبيل اليافعي</p>
</div>
<div id="updateDatePopup" class="update-date-popup">
  <h3>تحديث تاريخ التبرع</h3>
  <input type="date" id="newDonationDate">
  <button id="btn-save-donation-date">حفظ التحديث</button>
  <button id="btn-close-update-date-popup">إغلاق</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfIBS2gB4lkRZ1_ZerLk451EVfafrfWSM",
    authDomain: "qtratamal.firebaseapp.com",
    projectId: "qtratamal",
    storageBucket: "qtratamal.firebasestorage.app",
    messagingSenderId: "491056452067",
    appId: "1:491056452067:web:0c8ef019a651cd47c290d6"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentDonorDocId = null;
  let currentDisplayedDonors = [];

function normalizeArabic(text) {
    return text
      .toLowerCase()
      .trim()
      .replace(/[\u064B-\u065F]/g, '') // حذف التشكيل
      .replace(/[\u0622\u0623\u0625]/g, 'ا') // الهمزات إلى ألف
      .replace(/ة/g, 'ه') // تاء مربوطة إلى هاء
      .replace(/ى/g, 'ي') // ألف مقصورة إلى ياء
      .replace(/\s+/g, ' '); // إزالة الفراغات الزائدة
  }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'search') searchDonors();
    if (id === 'register') {
      document.querySelectorAll('#register input').forEach(i => i.value = '');
      document.getElementById('donorBlood').selectedIndex = 0;
    }
    if (id === 'edit') {
      document.getElementById('editSection').style.display = 'none';
      document.getElementById('editSearchInput').value = '';
      currentDonorDocId = null;
      document.getElementById('editingDonorId').textContent = '';
    }
  }
  function showPasswordPopup() { document.getElementById('passwordPopup').classList.add('active'); document.getElementById('passwordInput').value = ''; }
  function closePasswordPopup() { document.getElementById('passwordPopup').classList.remove('active'); }
  function checkPassword() { if (document.getElementById('passwordInput').value === "Na@7363Nabel") { closePasswordPopup(); showSection('edit'); } else alert('كلمة المرور غير صحيحة'); }

  function showMessage(msg) {
    const popup = document.getElementById('successPopup'); popup.innerHTML = msg; popup.classList.add('active'); setTimeout(() => popup.classList.remove('active'), 3000);
  }

  async function addDonor() {
   // الحصول على الاسم المدخل والتحقق من عدد الأسماء
  const donorName = document.getElementById('donorName').value.trim();
  const nameParts = donorName.split(/\s+/); // تقسيم الاسم بناءً على المسافات بين الكلمات

  // التحقق من أن الاسم يحتوي على ثلاثة إلى أربعة فقط
  if (nameParts.length < 3 || nameParts.length > 4) {
    showMessage("الاسم يجب أن يتكون من ثلاثة أسماء أو أربعة أسماء فقط.");
    return; // عدم متابعة الإجراء إذا كان الاسم غير صحيح
  }
    const d = {
      name: document.getElementById('donorName').value.trim(),
      phone: document.getElementById('donorPhone').value.trim(),
      city: document.getElementById('donorCity').value.trim(),
      area: document.getElementById('donorArea').value.trim(),
      location: document.getElementById('donorLocation').value.trim(),
      lastDate: document.getElementById('donorLastDate').value || null,
      whatsapp: document.getElementById('donorWhatsapp').value.trim(),
      blood: document.getElementById('donorBlood').value
    };
    if (!d.name || !d.phone || !d.city || !d.area || !d.location || !d.blood) { showMessage('يرجى تعبئة جميع الحقول الأساسية'); return; }

    // فحص التكرار في Firestore
      const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', d.phone)));
    if (!phoneSnap.empty) { showMessage('رقم الهاتف مسجل بالفعل'); return; }

    try {
      await addDoc(collection(db, 'donors'), d);
      showMessage('تم تسجيل بياناتك بنجاح جزاك الله خير');
      document.querySelectorAll('#register input').forEach(i => i.value = '');
      document.getElementById('donorBlood').selectedIndex = 0;
    } catch (e) {
      console.error(e);
      showMessage('حدث خطأ أثناء التسجيل');
    }
  }

  async function searchDonorToEdit() {
    const input = document.getElementById('editSearchInput').value.trim();
    if (!input) { showMessage('الرجاء إدخال الاسم أو رقم الهاتف'); return; }
    try {
      const snap = await getDocs(collection(db, 'donors'));
      const all = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const normInput = normalizeArabic(input);
      const found = all.find(d => {
        const normName = normalizeArabic(d.name || '');
        const normPhone = normalizeArabic(d.phone || '');
        return normName === normInput || normPhone === normInput;
      });
      if (found) {
        currentDonorDocId = found.id;
        document.getElementById('editingDonorId').textContent = found.id;
        document.getElementById('editSection').style.display = 'block';
        document.getElementById('editNewName').value = found.name;
        document.getElementById('editPhone').value = found.phone;
        document.getElementById('editCity').value = found.city;
        document.getElementById('editArea').value = found.area;
        document.getElementById('editLocation').value = found.location;
        document.getElementById('editLastDate').value = found.lastDate || '';
        document.getElementById('editBlood').value = found.blood;
        document.getElementById('editWhatsapp').value = found.whatsapp || '';
      } else {
        showMessage('المتبرع غير موجود');
      }
    } catch (e) { console.error(e); showMessage('خطأ أثناء البحث'); }
  }

  async function saveEdit() {
    if (!currentDonorDocId) { showMessage('لم يتم تحديد متبرع للتعديل'); return; }
    const updated = {
      name: document.getElementById('editNewName').value.trim(),
      phone: document.getElementById('editPhone').value.trim(),
      city: document.getElementById('editCity').value.trim(),
      area: document.getElementById('editArea').value.trim(),
      location: document.getElementById('editLocation').value.trim(),
      lastDate: document.getElementById('editLastDate').value || null,
      whatsapp: document.getElementById('editWhatsapp').value.trim(),
      blood: document.getElementById('editBlood').value
    };
    // فحص التكرار باستثناء المستند الحالي
    const nameSnap = await getDocs(query(collection(db, 'donors'), where('name', '==', updated.name)));
    if (!nameSnap.empty && nameSnap.docs.some(doc => doc.id !== currentDonorDocId)) { showMessage('هذا الاسم مسجل لمتبرع آخر'); return; }
    const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', updated.phone)));
    if (!phoneSnap.empty && phoneSnap.docs.some(doc => doc.id !== currentDonorDocId)) { showMessage('رقم الهاتف مسجل لمتبرع آخر'); return; }
    try {
      await updateDoc(doc(db, 'donors', currentDonorDocId), updated);
      showMessage('تم التعديل بنجاح');
      document.getElementById('editSection').style.display = 'none'; currentDonorDocId = null;
    } catch (e) { console.error(e); showMessage('خطأ أثناء الحفظ'); }
  }

  async function deleteDonor() { if (confirm('هل أنت متأكد من الحذف؟')) { await deleteDoc(doc(db, 'donors', currentDonorDocId)); showMessage('تم الحذف'); document.getElementById('editSection').style.display='none'; currentDonorDocId=null; } }

  function cancelEdit() { document.getElementById('editSection').style.display='none'; currentDonorDocId=null; }

  function renderSearchTable(donors) {
    const tbody = document.getElementById('donorsTable'); tbody.innerHTML = '';
    if (!donors.length) { tbody.innerHTML = '<tr><td colspan="8">لا يوجد متبرعون</td></tr>'; document.getElementById('donorCount').textContent = 'عدد المتبرعين: 0'; currentDisplayedDonors=[]; return; }
    currentDisplayedDonors = donors; document.getElementById('donorCount').textContent = `عدد المتبرعين: ${donors.length}`;
    donors.forEach(d => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td data-label="الاسم">${d.name}</td>
        <td data-label="الهاتف">
          <div style="display:flex;flex-direction:column;align-items:center;gap:5px;">
            <a href="tel:${d.phone}" style="color:white;background-color:#1b5e20;padding:5px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-weight:bold;font-size:12px;white-space:nowrap;">
              <svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" fill="white" viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.11-.21 11.72 11.72 0 003.69.6 1 1 0 011 1v3.18a1 1 0 01-1 1A17.93 17.93 0 013 5a1 1 0 011-1h3.18a1 1 0 011 1 11.72 11.72 0 00.6 3.69 1 1 0 01-.21 1.11l-2.2 2.2z"/></svg>
              اضغط للإتصال
            </a>
            <span style="color:#b30000;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${d.phone}</span>
          </div>
        </td>
        <td data-label="الفصيلة">${d.blood}</td>
        <td data-label="المحافظة">${d.city}</td>
        <td data-label="المديرية">${d.area}</td>
        <td data-label="السكن">${d.location}</td>
        <td data-label="الواتساب" style="text-align: center;">
  ${
    d.whatsapp
      ? `<a href="https://wa.me/${d.whatsapp}" target="_blank"
            style="color:green; text-decoration:none; font-weight:bold;
                   display:flex; flex-direction:column; align-items:center;
                   font-size: 0.95em;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <i class="fab fa-whatsapp" style="font-size:1.2em;"></i>
              <span>${d.whatsapp}</span>
            </div>
            <small style="color:#444; font-weight:normal; margin-top:3px;">
              اضغط للتواصل واتساب مباشرة
            </small>
         </a>`
      : "—"
  }
</td>

        <td data-label="آخر تبرع">${d.lastDate||'—'}</td>
        <td data-label="تعديل تاريخ التبرع"><button data-donor-id="${d.id}" class="btn-update-date">تحديث تاريخ تبرعك</button></td>
      `;
    });
    document.querySelectorAll('.btn-update-date').forEach(btn => btn.addEventListener('click', () => enableEditDate(btn.getAttribute('data-donor-id'))));
  }

  async function searchDonors() {
    const blood = document.getElementById('searchBlood').value;
    const text = normalizeArabic(document.getElementById('searchQuery').value);
    let q = collection(db, 'donors');
    if (blood) q = query(q, where('blood','==',blood));
    const snap = await getDocs(q);
    let donors = snap.docs.map(d => ({ id:d.id,...d.data() }));
    if (text) donors = donors.filter(d => {
      const fields = [d.name, d.phone, d.city, d.area, d.location].map(f => normalizeArabic(f || ''));
      return fields.some(f => f.includes(text));
    });
    renderSearchTable(donors);
  }

  function enableEditDate(id) { currentDonorDocId = id; document.getElementById('updateDatePopup').classList.add('active'); document.getElementById('newDonationDate').value = ''; }

  async function saveDonationDate() {
    const newDate = document.getElementById('newDonationDate').value;
    if (!newDate) { alert('يرجى إدخال تاريخ'); return; }
    try { await updateDoc(doc(db,'donors',currentDonorDocId),{ lastDate:newDate }); showMessage('تم تحديث تاريخ التبرع'); closeUpdateDatePopup(); searchDonors(); currentDonorDocId=null; }
    catch(e){ console.error(e); showMessage('خطأ أثناء التحديث'); }
  }
  function closeUpdateDatePopup() { document.getElementById('updateDatePopup').classList.remove('active'); currentDonorDocId=null; }

  // تصدير PDF
  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF();
    const columns = ["الاسم","الهاتف","الفصيلة","المحافظة","المديرية","السكن","آخر تبرع"];
    const rows = currentDisplayedDonors.map(d => [d.name, d.phone, d.blood, d.city, d.area, d.location, d.lastDate||'']);
    docPDF.autoTable({ head:[columns], body:rows });
    docPDF.save('donors.pdf');
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btn-show-register').addEventListener('click', () => showSection('register'));
    document.getElementById('btn-show-password-popup').addEventListener('click', showPasswordPopup);
    document.getElementById('btn-show-search').addEventListener('click', () => showSection('search'));
    document.getElementById('btn-add-donor').addEventListener('click', addDonor);
    document.getElementById('btn-search-donor-edit').addEventListener('click', searchDonorToEdit);
    document.getElementById('btn-save-edit').addEventListener('click', saveEdit);
    document.getElementById('btn-delete-donor').addEventListener('click', deleteDonor);
    document.getElementById('btn-cancel-edit').addEventListener('click', cancelEdit);
    document.getElementById('btn-check-password').addEventListener('click', checkPassword);
    document.getElementById('btn-close-password-popup').addEventListener('click', closePasswordPopup);
    document.getElementById('searchBlood').addEventListener('change', searchDonors);
    document.getElementById('searchQuery').addEventListener('input', searchDonors);
    document.getElementById('btn-save-donation-date').addEventListener('click', saveDonationDate);
    document.getElementById('btn-close-update-date-popup').addEventListener('click', closeUpdateDatePopup);
    document.getElementById('btn-export-pdf').addEventListener('click', exportPDF);
    showSection('register');
  });
</script>

</body>
</html>
