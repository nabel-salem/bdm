<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø·Ø±Ø© Ø£Ù…Ù„</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Arial', sans-serif; background: #f0f0f0; margin: 0; padding: 0; }
    header { background-color: #b30000; color: white; text-align: center; padding: 15px; font-size: 20px; }
    nav { display: flex; flex-wrap: wrap; justify-content: space-around; background-color: #ffcccc; padding: 10px; }
    nav button { background-color: #b30000; color: white; border: none; border-radius: 8px; padding: 10px 20px; margin: 5px; cursor: pointer; }
    .section { display: none; padding: 20px; }
    .active { display: block; }
    input, select, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .field-label { color: #b30000; font-size: 14px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    td, th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 10px; text-align: center; }
    thead { background-color: #b30000; color: white; }
    tbody tr { border: 2px solid #b30000; margin-bottom: 10px; }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr { margin-bottom: 15px; border: 2px solid #b30000; padding: 10px; border-radius: 10px; background-color: #fff; }
      td { text-align: right; padding-right: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
      td::before { content: attr(data-label); position: absolute; right: 10px; top: 10px; font-weight: bold; color: #b30000; }
      td:last-child { border-bottom: none; }
    }
    .popup-message, .update-date-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid red; border-radius: 10px; z-index: 1000; text-align: center; }
    .popup-message.active, .update-date-popup.active { display: block; }
  </style>
  <!-- jsPDF and AutoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<header>ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø·Ø±Ø© Ø£Ù…Ù„ ... Ù‚Ø·Ø±Ø© Ø£Ù…Ù„ ØªÙ†Ù‚Ø° Ø­ÙŠØ§Ø©</header>
<div style="background-color: #fff5f5; border: 1px solid #f44336; border-radius: 10px; padding: 15px; margin: 20px auto; max-width: 700px; text-align: center; font-size: 0.90em; color: #b71c1c; line-height: 1.6;">
  <p>ğŸ©¸ ØªÙ… ØªØµÙ…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„ØªØ³Ù‡ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ØªØ¨Ø±Ø¹ÙŠÙ† Ø¨Ø§Ù„Ø¯Ù…ØŒ ÙˆØªÙˆÙÙŠØ± ÙØµØ§Ø¦Ù„ Ø§Ù„Ø¯Ù… Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ø¨Ø³Ø±Ø¹Ø© ÙˆØ³Ù‡ÙˆÙ„Ø© Ù„ÙƒÙ„ Ù…Ù† ÙŠØ­ØªØ§Ø¬ Ø¥Ù„ÙŠÙ‡Ø§.</p>
  <p>ğŸ”´ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…ØªØ¨Ø±Ø¹ÙŠÙ† ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù… Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙÙ‚Ø· Ù„ÙƒÙŠ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„.</p>
  <p>ğŸ”´ ÙˆÙ„Ù„Ø¨Ø§Ø­Ø«ÙŠÙ† Ø¹Ù† Ù…ØªØ¨Ø±Ø¹ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ØªØ¨Ø±Ø¹ ÙˆØ³ØªØ¬Ø¯ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø§ÙØ°Ø©.</p>
</div>

<nav>
  <button id="btn-show-register">ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ¨Ø±Ø¹ Ø¬Ø¯ÙŠØ¯</button>
  <button id="btn-show-password-popup">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  <button id="btn-show-search">Ø¨Ø­Ø« Ø¹Ù† Ù…ØªØ¨Ø±Ø¹</button>
</nav>

<div id="register" class="section active">
  <h3>ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ¨Ø±Ø¹ Ø¬Ø¯ÙŠØ¯</h3>
  <input type="text" id="donorName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
  <input type="text" id="donorPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
  <input type="text" id="donorWhatsapp" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙŠÙƒÙˆÙ† ØµÙŠØºØ© Ø§Ù„Ø±Ù‚Ù… (*********967)">
  <input type="text" id="donorCity" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
  <input type="text" id="donorArea" placeholder="Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©">
  <input type="text" id="donorLocation" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒÙ†">
  <label class="field-label">ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ¨Ø±Ø¹ Ù„Ùƒ (ÙˆØ¥Ø°Ø§ Ù„Ù… ØªØªØ¨Ø±Ø¹ Ø¨Ø¹Ø¯ ÙØ§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹) ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø­Ø§Ù„ Ù‚Ù…Øª Ø¨Ø§Ù„ØªØ¨Ø±Ø¹.</label>
  <input type="date" id="donorLastDate">
  <select id="donorBlood">
    <option disabled selected value="">Ø§Ø®ØªØ± ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</option>
    <option>+A</option><option>-A</option>
    <option>+B</option><option>-B</option>
    <option>+AB</option><option>-AB</option>
    <option>+O</option><option>-O</option>
  </select>
  <button id="btn-add-donor">ØªØ³Ø¬ÙŠÙ„</button>
</div>

<div id="edit" class="section">
  <h3>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¨Ø±Ø¹</h3>
  <input type="text" id="editSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¨Ø±Ø¹ Ø£Ùˆ Ø±Ù‚Ù…Ù‡ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">
  <button id="btn-search-donor-edit">Ø¨Ø­Ø«</button>
  <div id="editSection" style="display:none;">
    <p>Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¨Ø±Ø¹ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù: <span id="editingDonorId"></span></p>
    <input type="text" id="editNewName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
    <input type="text" id="editPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input type="text" id="editWhatsapp" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
    <input type="text" id="editCity" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
    <input type="text" id="editArea" placeholder="Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©">
    <input type="text" id="editLocation" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø³ÙƒÙ†">
    <input type="date" id="editLastDate">
    <select id="editBlood">
      <option>+A</option><option>-A</option>
      <option>+B</option><option>-B</option>
      <option>+AB</option><option>-AB</option>
      <option>+O</option><option>-O</option>
    </select>
    <button id="btn-save-edit">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    <button id="btn-delete-donor">Ø­Ø°Ù Ø§Ù„Ù…ØªØ¨Ø±Ø¹</button>
    <button id="btn-cancel-edit">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div id="search" class="section">
  <h3>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ØªØ¨Ø±Ø¹ÙŠÙ†</h3>
  <select id="searchBlood">
    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµØ§Ø¦Ù„</option>
    <option>+A</option><option>-A</option>
    <option>+B</option><option>-B</option>
    <option>+AB</option><option>-AB</option>
    <option>+O</option><option>-O</option>
  </select>
  <input type="text" id="searchQuery" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ© Ø£Ùˆ Ø§Ù„Ø³ÙƒÙ†">
  <div id="donorCount" style="margin:15px 0;font-size:18px;font-weight:bold;color:#333;text-align:center;"></div>
  <button id="btn-export-pdf">ØªØ­Ù…ÙŠÙ„ PDF</button>
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„ÙØµÙŠÙ„Ø©</th><th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th><th>Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©</th><th>Ø§Ù„Ø³ÙƒÙ†</th><th>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th><th>Ø¢Ø®Ø± ØªØ¨Ø±Ø¹</th><th>ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¨Ø±Ø¹</th>
      </tr>
    </thead>
    <tbody id="donorsTable"></tbody>
  </table>
</div>

<div id="successPopup" class="popup-message"></div>
<div id="passwordPopup" class="popup-message">
  <p>Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
  <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
  <button id="btn-check-password">Ø¯Ø®ÙˆÙ„</button>
  <button id="btn-close-password-popup">Ø¥ØºÙ„Ø§Ù‚</button>
  <p style="font-size:12px;color:gray;">Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°ÙØŒ ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³: 00966511479262 Ù†Ø¨ÙŠÙ„ Ø§Ù„ÙŠØ§ÙØ¹ÙŠ</p>
</div>
<div id="updateDatePopup" class="update-date-popup">
  <h3>ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¨Ø±Ø¹</h3>
  <input type="date" id="newDonationDate">
  <button id="btn-save-donation-date">Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«</button>
  <button id="btn-close-update-date-popup">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDfIBS2gB4lkRZ1_ZerLk451EVfafrfWSM",
    authDomain: "qtratamal.firebaseapp.com",
    projectId: "qtratamal",
    storageBucket: "qtratamal.firebasestorage.app",
    messagingSenderId: "491056452067",
    appId: "1:491056452067:web:0c8ef019a651cd47c290d6"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentDonorDocId = null;
  let currentDisplayedDonors = [];

function normalizeArabic(text) {
    return text
      .toLowerCase()
      .trim()
      .replace(/[\u064B-\u065F]/g, '') // Ø­Ø°Ù Ø§Ù„ØªØ´ÙƒÙŠÙ„
      .replace(/[\u0622\u0623\u0625]/g, 'Ø§') // Ø§Ù„Ù‡Ù…Ø²Ø§Øª Ø¥Ù„Ù‰ Ø£Ù„Ù
      .replace(/Ø©/g, 'Ù‡') // ØªØ§Ø¡ Ù…Ø±Ø¨ÙˆØ·Ø© Ø¥Ù„Ù‰ Ù‡Ø§Ø¡
      .replace(/Ù‰/g, 'ÙŠ') // Ø£Ù„Ù Ù…Ù‚ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ÙŠØ§Ø¡
      .replace(/\s+/g, ' '); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
  }

  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === 'search') searchDonors();
    if (id === 'register') {
      document.querySelectorAll('#register input').forEach(i => i.value = '');
      document.getElementById('donorBlood').selectedIndex = 0;
    }
    if (id === 'edit') {
      document.getElementById('editSection').style.display = 'none';
      document.getElementById('editSearchInput').value = '';
      currentDonorDocId = null;
      document.getElementById('editingDonorId').textContent = '';
    }
  }
  function showPasswordPopup() { document.getElementById('passwordPopup').classList.add('active'); document.getElementById('passwordInput').value = ''; }
  function closePasswordPopup() { document.getElementById('passwordPopup').classList.remove('active'); }
  function checkPassword() { if (document.getElementById('passwordInput').value === "Na@7363Nabel") { closePasswordPopup(); showSection('edit'); } else alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); }

  function showMessage(msg) {
    const popup = document.getElementById('successPopup'); popup.innerHTML = msg; popup.classList.add('active'); setTimeout(() => popup.classList.remove('active'), 3000);
  }

  async function addDonor() {
    const d = {
      name: document.getElementById('donorName').value.trim(),
      phone: document.getElementById('donorPhone').value.trim(),
      city: document.getElementById('donorCity').value.trim(),
      area: document.getElementById('donorArea').value.trim(),
      location: document.getElementById('donorLocation').value.trim(),
      lastDate: document.getElementById('donorLastDate').value || null,
      whatsapp: document.getElementById('donorWhatsapp').value.trim(),
      blood: document.getElementById('donorBlood').value
    };
    if (!d.name || !d.phone || !d.city || !d.area || !d.location || !d.blood) { showMessage('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'); return; }

    // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Firestore
      const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', d.phone)));
    if (!phoneSnap.empty) { showMessage('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„'); return; }

    try {
      await addDoc(collection(db, 'donors'), d);
      showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±');
      document.querySelectorAll('#register input').forEach(i => i.value = '');
      document.getElementById('donorBlood').selectedIndex = 0;
    } catch (e) {
      console.error(e);
      showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
    }
  }

  async function searchDonorToEdit() {
    const input = document.getElementById('editSearchInput').value.trim();
    if (!input) { showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'); return; }
    try {
      const snap = await getDocs(collection(db, 'donors'));
      const all = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const normInput = normalizeArabic(input);
      const found = all.find(d => {
        const normName = normalizeArabic(d.name || '');
        const normPhone = normalizeArabic(d.phone || '');
        return normName === normInput || normPhone === normInput;
      });
      if (found) {
        currentDonorDocId = found.id;
        document.getElementById('editingDonorId').textContent = found.id;
        document.getElementById('editSection').style.display = 'block';
        document.getElementById('editNewName').value = found.name;
        document.getElementById('editPhone').value = found.phone;
        document.getElementById('editCity').value = found.city;
        document.getElementById('editArea').value = found.area;
        document.getElementById('editLocation').value = found.location;
        document.getElementById('editLastDate').value = found.lastDate || '';
        document.getElementById('editBlood').value = found.blood;
        document.getElementById('editWhatsapp').value = found.whatsapp || '';
      } else {
        showMessage('Ø§Ù„Ù…ØªØ¨Ø±Ø¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      }
    } catch (e) { console.error(e); showMessage('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«'); }
  }

  async function saveEdit() {
    if (!currentDonorDocId) { showMessage('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ØªØ¨Ø±Ø¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„'); return; }
    const updated = {
      name: document.getElementById('editNewName').value.trim(),
      phone: document.getElementById('editPhone').value.trim(),
      city: document.getElementById('editCity').value.trim(),
      area: document.getElementById('editArea').value.trim(),
      location: document.getElementById('editLocation').value.trim(),
      lastDate: document.getElementById('editLastDate').value || null,
      whatsapp: document.getElementById('editWhatsapp').value.trim(),
      blood: document.getElementById('editBlood').value
    };
    // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const nameSnap = await getDocs(query(collection(db, 'donors'), where('name', '==', updated.name)));
    if (!nameSnap.empty && nameSnap.docs.some(doc => doc.id !== currentDonorDocId)) { showMessage('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù„Ù…ØªØ¨Ø±Ø¹ Ø¢Ø®Ø±'); return; }
    const phoneSnap = await getDocs(query(collection(db, 'donors'), where('phone', '==', updated.phone)));
    if (!phoneSnap.empty && phoneSnap.docs.some(doc => doc.id !== currentDonorDocId)) { showMessage('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù„Ù…ØªØ¨Ø±Ø¹ Ø¢Ø®Ø±'); return; }
    try {
      await updateDoc(doc(db, 'donors', currentDonorDocId), updated);
      showMessage('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
      document.getElementById('editSection').style.display = 'none'; currentDonorDocId = null;
    } catch (e) { console.error(e); showMessage('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
  }

  async function deleteDonor() { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) { await deleteDoc(doc(db, 'donors', currentDonorDocId)); showMessage('ØªÙ… Ø§Ù„Ø­Ø°Ù'); document.getElementById('editSection').style.display='none'; currentDonorDocId=null; } }

  function cancelEdit() { document.getElementById('editSection').style.display='none'; currentDonorDocId=null; }

  function renderSearchTable(donors) {
    const tbody = document.getElementById('donorsTable'); tbody.innerHTML = '';
    if (!donors.length) { tbody.innerHTML = '<tr><td colspan="8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¨Ø±Ø¹ÙˆÙ†</td></tr>'; document.getElementById('donorCount').textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¨Ø±Ø¹ÙŠÙ†: 0'; currentDisplayedDonors=[]; return; }
    currentDisplayedDonors = donors; document.getElementById('donorCount').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¨Ø±Ø¹ÙŠÙ†: ${donors.length}`;
    donors.forEach(d => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td data-label="Ø§Ù„Ø§Ø³Ù…">${d.name}</td>
        <td data-label="Ø§Ù„Ù‡Ø§ØªÙ">
          <div style="display:flex;flex-direction:column;align-items:center;gap:5px;">
            <a href="tel:${d.phone}" style="color:white;background-color:#b30000;padding:5px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:6px;text-decoration:none;font-weight:bold;font-size:12px;white-space:nowrap;">
              <svg xmlns="http://www.w3.org/2000/svg" height="18" width="18" fill="white" viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.11-.21 11.72 11.72 0 003.69.6 1 1 0 011 1v3.18a1 1 0 01-1 1A17.93 17.93 0 013 5a1 1 0 011-1h3.18a1 1 0 011 1 11.72 11.72 0 00.6 3.69 1 1 0 01-.21 1.11l-2.2 2.2z"/></svg>
              Ø§Ø¶ØºØ· Ù„Ù„Ø¥ØªØµØ§Ù„
            </a>
            <span style="color:#b30000;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${d.phone}</span>
          </div>
        </td>
        <td data-label="Ø§Ù„ÙØµÙŠÙ„Ø©">${d.blood}</td>
        <td data-label="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">${d.city}</td>
        <td data-label="Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©">${d.area}</td>
        <td data-label="Ø§Ù„Ø³ÙƒÙ†">${d.location}</td>
        <td data-label="Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" style="text-align: center;">
  ${
    d.whatsapp
      ? `<a href="https://wa.me/${d.whatsapp}" target="_blank"
            style="color:green; text-decoration:none; font-weight:bold;
                   display:flex; flex-direction:column; align-items:center;
                   font-size: 0.95em;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <i class="fab fa-whatsapp" style="font-size:1.2em;"></i>
              <span>${d.whatsapp}</span>
            </div>
            <small style="color:#444; font-weight:normal; margin-top:3px;">
              Ø§Ø¶ØºØ· Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©
            </small>
         </a>`
      : "â€”"
  }
</td>

        <td data-label="Ø¢Ø®Ø± ØªØ¨Ø±Ø¹">${d.lastDate||'â€”'}</td>
        <td data-label="ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¨Ø±Ø¹"><button data-donor-id="${d.id}" class="btn-update-date">ØªØ­Ø¯ÙŠØ«</button></td>
      `;
    });
    document.querySelectorAll('.btn-update-date').forEach(btn => btn.addEventListener('click', () => enableEditDate(btn.getAttribute('data-donor-id'))));
  }

  async function searchDonors() {
    const blood = document.getElementById('searchBlood').value;
    const text = normalizeArabic(document.getElementById('searchQuery').value);
    let q = collection(db, 'donors');
    if (blood) q = query(q, where('blood','==',blood));
    const snap = await getDocs(q);
    let donors = snap.docs.map(d => ({ id:d.id,...d.data() }));
    if (text) donors = donors.filter(d => {
      const fields = [d.name, d.phone, d.city, d.area, d.location].map(f => normalizeArabic(f || ''));
      return fields.some(f => f.includes(text));
    });
    renderSearchTable(donors);
  }

  function enableEditDate(id) { currentDonorDocId = id; document.getElementById('updateDatePopup').classList.add('active'); document.getElementById('newDonationDate').value = ''; }

  async function saveDonationDate() {
    const newDate = document.getElementById('newDonationDate').value;
    if (!newDate) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ®'); return; }
    try { await updateDoc(doc(db,'donors',currentDonorDocId),{ lastDate:newDate }); showMessage('ØªÙ… ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¨Ø±Ø¹'); closeUpdateDatePopup(); searchDonors(); currentDonorDocId=null; }
    catch(e){ console.error(e); showMessage('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«'); }
  }
  function closeUpdateDatePopup() { document.getElementById('updateDatePopup').classList.remove('active'); currentDonorDocId=null; }

  // ØªØµØ¯ÙŠØ± PDF
  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF();
    const columns = ["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‡Ø§ØªÙ","Ø§Ù„ÙØµÙŠÙ„Ø©","Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©","Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©","Ø§Ù„Ø³ÙƒÙ†","Ø¢Ø®Ø± ØªØ¨Ø±Ø¹"];
    const rows = currentDisplayedDonors.map(d => [d.name, d.phone, d.blood, d.city, d.area, d.location, d.lastDate||'']);
    docPDF.autoTable({ head:[columns], body:rows });
    docPDF.save('donors.pdf');
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btn-show-register').addEventListener('click', () => showSection('register'));
    document.getElementById('btn-show-password-popup').addEventListener('click', showPasswordPopup);
    document.getElementById('btn-show-search').addEventListener('click', () => showSection('search'));
    document.getElementById('btn-add-donor').addEventListener('click', addDonor);
    document.getElementById('btn-search-donor-edit').addEventListener('click', searchDonorToEdit);
    document.getElementById('btn-save-edit').addEventListener('click', saveEdit);
    document.getElementById('btn-delete-donor').addEventListener('click', deleteDonor);
    document.getElementById('btn-cancel-edit').addEventListener('click', cancelEdit);
    document.getElementById('btn-check-password').addEventListener('click', checkPassword);
    document.getElementById('btn-close-password-popup').addEventListener('click', closePasswordPopup);
    document.getElementById('searchBlood').addEventListener('change', searchDonors);
    document.getElementById('searchQuery').addEventListener('input', searchDonors);
    document.getElementById('btn-save-donation-date').addEventListener('click', saveDonationDate);
    document.getElementById('btn-close-update-date-popup').addEventListener('click', closeUpdateDatePopup);
    document.getElementById('btn-export-pdf').addEventListener('click', exportPDF);
    showSection('register');
  });
</script>

</body>
</html>
